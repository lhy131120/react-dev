import { api } from "@/services";
import { useEffect, useState, useCallback, useRef } from "react";
import { toast } from "react-toastify";
import DeleteConfirmModal from "@/components/DeleteConfirmModal";

const Cart = () => {
	const [tempCarts, setTempCarts] = useState([]);
	const [cartTotal, setcartTotal] = useState(null);
	const [finalTotal, setFinalTotal] = useState(null);
	const [updatingCarts, setUpdatingCarts] = useState(new Set());
	const [isClearingAll, setIsClearingAll] = useState(false);

	// 刪除確認 Modal
	const deleteModalRef = useRef(null);
	const [deleteTarget, setDeleteTarget] = useState(null); // { type: 'single' | 'all', cart?: object }

	const getCart = useCallback(async () => {
		try {
			const response = await api.get(`/cart`);
			const { final_total, total, carts } = response.data.data;

			setTempCarts([...carts]);
			setcartTotal(total);
			setFinalTotal(final_total);

			toast.success(`取得購物車成功!`);
		} catch (error) {
			toast.error(`取得購物車失敗: ${error.response?.data?.message}`);
		}
	}, []);

	const handleUpdateQty = async (cartId, newQty) => {
		// 轉型Number
		const safeQty = Math.max(1, Number(newQty));
		if (isNaN(safeQty) || safeQty < 1) return;

		const cartItem = tempCarts.find((item) => item.id === cartId);
		if (!cartItem) return;

		if (safeQty === cartItem.qty) return;

		setTempCarts((prevCarts) => prevCarts.map((item) => (item.id === cartId ? { ...item, qty: safeQty } : item)));
		setUpdatingCarts((prev) => new Set([...prev, cartId]));

		try {
			const payload = {
				data: {
					product_id: cartItem.product?.id,
					qty: safeQty,
				},
			};

			const response = await api.put(`/cart/${cartId}`, payload);

			await getCart(); // 如果後端有其他計算（如折扣），建議重新拉一次

			// console.log(`購物車項目 ${cartId} 數量更新為 ${safeQty}`);

			toast.success(`${response.data?.message || "成功更新"}!`);
			// console.log(response.data.message)
		} catch (error) {
			// 失敗時回滾 UI
			setTempCarts((prevCarts) =>
				prevCarts.map((item) => (item.id === cartId ? { ...item, qty: cartItem.qty } : item))
			);

			toast.error(`更新購物車數量失敗: ${error.response?.data?.message}`);
		} finally {
			// 結束 loading 狀態
			setUpdatingCarts((prev) => {
				const next = new Set(prev);
				next.delete(cartId);
				return next;
			});
		}
	};

	const handleRemoveCart = async (cartId) => {
		if (updatingCarts.has(cartId)) return;

		const removedItem = tempCarts.find((item) => item.id === cartId);
		setTempCarts((prev) => prev.filter((item) => item.id !== cartId));
		setUpdatingCarts((prev) => new Set([...prev, cartId]));

		try {
			const response = await api.delete(`/cart/${cartId}`);

			toast.success(`產品已移除！${response.data.message || ""}`);

			await getCart();
		} catch (error) {
			// 失敗 → 回滾 UI
			if (removedItem) {
				setTempCarts((prev) => [...prev, removedItem]); // 放回原位（或依序插入）
			}

			toast.error(`刪除失敗：${error.response?.data?.message || "請稍後再試"}`);
		} finally {
			// 移除 loading 標記
			setUpdatingCarts((prev) => {
				const next = new Set(prev);
				next.delete(cartId);
				return next;
			});
		}
	};

	const handleRemoveAllCart = async () => {
		if (isClearingAll || tempCarts.length === 0) return;

		// 錯誤時回復用
		const backupCarts = [...tempCarts];
		const backupTotal = cartTotal;
		const backupFinalTotal = finalTotal;

		setTempCarts([]);
		setcartTotal(0);
		setFinalTotal(0);
		setIsClearingAll(true);

		try {
			const response = await api.delete(`/carts`);

			toast.success(`購物車已清空！${response.data.message || ""}`);

			await getCart();
		} catch (error) {
			setTempCarts(backupCarts);
			setcartTotal(backupTotal);
			setFinalTotal(backupFinalTotal);

			toast.error(`清空購物車失敗 "口"''：${error.response?.data?.message || "請稍後再試"}`);
		} finally {
			setIsClearingAll(false);
		}
	};

	// 開啟刪除確認 Modal
	const openDeleteConfirm = (type, cart = null) => {
		setDeleteTarget({ type, cart });
		deleteModalRef.current?.show();
	};

	// 關閉 Modal
	const closeDeleteModal = () => {
		deleteModalRef.current?.hide();
		setDeleteTarget(null);
	};

	// 確認刪除
	const confirmDelete = () => {
		if (deleteTarget?.type === "single" && deleteTarget.cart) {
			handleRemoveCart(deleteTarget.cart.id);
		} else if (deleteTarget?.type === "all") {
			handleRemoveAllCart();
		}
		closeDeleteModal();
	};

	useEffect(() => {
		getCart();
		return () => {};
	}, [getCart]);

	return (
		<>
			<h2 className="fs-4 fw-bold text-primary mb-4">購物車</h2>
			<div className="bg-white p-2 rounded-3">
				{tempCarts.length === 0 ? (
					<h2 className="text-center mb-0 py-5 text-primary">目前購物車空空 `A'</h2>
				) : (
					<>
						<div className="mb-2">
							<button
								type="button"
								className="btn btn-sm btn-danger border-2 text-white d-flex align-items-center gap-1 ms-auto"
								style={{ whiteSpace: "nowrap" }}
								onClick={() => openDeleteConfirm("all")}
							>
								<span className="spinner-border spinner-border-sm d-none" aria-hidden="true"></span>刪除所有
							</button>
						</div>
						<div className="table-responsive ">
							<table className="table align-middle">
								<thead>
									<tr>
										<th scope="col"></th>
										<th scope="col">品名</th>
										<th scope="col">數量/單位</th>
										<th scope="col">小計</th>
										<th scope="col"></th>
									</tr>
								</thead>
								<tbody>
									{tempCarts.map((cart) => (
										<tr key={cart.id}>
											<td style={{ width: "100px" }}>
												<img
													src={cart.product.imageUrl}
													style={{ width: "80px", height: "80px", objectFit: "cover" }}
													alt=""
												/>
											</td>
											<td style={{ whiteSpace: "nowrap" }}>
												<div>{cart.product?.title}</div>
												{cart.product?.flavor && cart.product.flavor.length > 0 && (
													<small className="text-muted">
														口味：{cart.product.flavor.join("、")}
													</small>
												)}
											</td>
											<td>
												<div className="d-flex align-items-center gap-2">
													<button
														type="button"
														className="cart-qty-btn"
														onClick={() => handleUpdateQty(cart.id, cart.qty - 1)}
														disabled={cart.qty <= 1 || updatingCarts.has(cart.id)}
													>
														−
													</button>

													<select
														className="cart-qty-select"
														value={cart.qty}
														onChange={(e) => handleUpdateQty(cart.id, Number(e.target.value))}
														disabled={updatingCarts.has(cart.id)}
													>
														{Array.from({ length: 20 }, (_, i) => i + 1).map((num) => (
															<option key={num} value={num}>
																{num}
															</option>
														))}
													</select>

													<button
														type="button"
														className="cart-qty-btn"
														onClick={() => handleUpdateQty(cart.id, cart.qty + 1)}
														disabled={cart.qty >= cart.product.stock || updatingCarts.has(cart.id)}
													>
														+
													</button>
												</div>
											</td>
											<td>{cart.final_total}</td>
											<td>
												<button
													type="button"
													className="btn btn-sm btn-danger border-2 text-white d-flex align-items-center gap-1"
													style={{ whiteSpace: "nowrap" }}
													onClick={() => openDeleteConfirm("single", cart)}
													disabled={updatingCarts.has(cart.id)}
												>
													<span
														className={`spinner-border spinner-border-sm ${updatingCarts.has(cart.id) ? "d-block" : "d-none"}`}
														aria-hidden="true"
													></span>
													{updatingCarts.has(cart.id) ? "刪除中..." : "刪除"}
												</button>
											</td>
										</tr>
									))}
								</tbody>
								<tfoot>
									<tr>
										<td colSpan={4} className="text-end">
											總數:
										</td>
										<td className="text-center">{cartTotal}</td>
									</tr>
									<tr>
										<td colSpan={4} className="text-end">
											拆扣後?:
										</td>
										<td className="text-center">{finalTotal}</td>
									</tr>
								</tfoot>
							</table>
						</div>

            <hr />
					</>
				)}
			</div>

			{/* 刪除確認 Modal */}
			<DeleteConfirmModal
				ref={deleteModalRef}
				tempProduct={{
					id: deleteTarget?.cart?.id || "all",
					title:
						deleteTarget?.type === "all"
							? "所有購物車商品"
							: deleteTarget?.cart?.product?.title,
				}}
				handleDeleteItem={confirmDelete}
				closeModal={closeDeleteModal}
			/>
		</>
	);
};

export default Cart;
